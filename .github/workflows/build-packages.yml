name: build-packages

on:
  push:
    branches: [main]

env:
  NIXPKGS_ALLOW_UNFREE: 1

jobs:
  build-packages:
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        pkg:
          - adept2-runtime
          - waveforms
        nixpkgs_branch:
          - nixos-unstable
          - nixos-21.05
        system:
          - x86_64-linux
          - aarch64-linux

    name: "Build ${{ matrix.pkg }} for ${{ matrix.nixpkgs_branch }} on ${{ matrix.system }}"

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v14
        with:
          install_url: https://github.com/numtide/nix-unstable-installer/releases/download/nix-2.5pre20211015_130284b/install
          extra_nix_config: |
            experimental-features = nix-command flakes
      - uses: cachix/cachix-action@v10
        with:
          name: liff
          signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - uses: nixbuild/nixbuild-action@v7
        with:
          nixbuild_ssh_key: '${{ secrets.NIXBUILD_SSH_KEY }}'
      - name: Build package ${{ matrix.pkg }}
        run: |-
          nix -L build \
              --impure \
              --override-input nixpkgs github:nixos/nixpkgs/${{ matrix.nixpkgs_branch }} \
              --system ${{ matrix.system }} \
              .#${{ matrix.pkg }}
